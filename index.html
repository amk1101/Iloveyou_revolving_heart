<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>“i love you …”</title>

<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&display=swap" rel="stylesheet">

<style>
  :root{
    --bg1:#07070a;
    --bg2:#0d0f15;
    --pink:#ff4d88;
    --maroon:#a0133b;
    --text:#ffe6ef;
  }
  html,body{height:100%;margin:0;background:radial-gradient(1200px 900px at 70% 20%, var(--bg2), var(--bg1));color:#fff;overflow:hidden;}
  body{font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial;}

  .topbar{
    position: fixed; left: 50%; top: 10px; transform: translateX(-50%);
    display:flex; gap:8px; align-items:center; z-index:10; pointer-events:none;
  }
  .topbar .field{
    display:flex; gap:6px; align-items:center; pointer-events:auto;
    padding:6px 8px; border-radius:999px;
    background: rgba(10,10,14,.45); border:1px solid rgba(255,255,255,.14);
    backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
  }
  .topbar input{
    width: clamp(160px, 28vw, 320px);
    height: 26px; padding:0 10px; border-radius:999px;
    border:1px solid rgba(255,255,255,.18);
    background: rgba(255,255,255,.04); color:#fff; outline:none; font-size:13px;
  }
  .topbar button{
    height:28px; min-width:28px; display:grid; place-items:center;
    border-radius:999px; border:1px solid rgba(255,255,255,.18);
    background: rgba(255,255,255,.08); color:#fff; cursor:pointer;
  }
  .icon{width:16px;height:16px;display:block}

  #app{position:fixed; inset:0; touch-action:none;}
  canvas{display:block;}

  .footer{
    position: fixed; left:50%; transform: translateX(-50%);
    bottom: 10px; display:flex; gap:10px; align-items:center; z-index:10; pointer-events:none;
  }
  .pill{
    display:flex; align-items:center; gap:8px; pointer-events:auto;
    padding:6px 10px; border-radius:999px;
    background: rgba(10,10,14,.45); border:1px solid rgba(255,255,255,.14);
    backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
  }
  .sharebtn{
    display:flex; align-items:center; gap:6px; cursor:pointer;
    border-radius:999px; border:1px solid rgba(255,255,255,.18);
    background: rgba(255,255,255,.08); padding:6px 10px; color:#fff;
  }
  .credit{font-size:11px; opacity:.9}
  .credit a{color:#fff; text-decoration:none}
  .gh{width:16px;height:16px; display:inline-block; vertical-align:-3px; opacity:.95}

  .sheet{
    position: fixed; left:0; right:0; bottom:-220px; z-index:20;
    background: rgba(8,8,12,.86); border-top:1px solid rgba(255,255,255,.14);
    box-shadow: 0 -10px 32px rgba(0,0,0,.35);
    transition: bottom .25s ease; padding: 12px;
    backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
  }
  .sheet.open{ bottom:0; }
  .sheet .row{ display:flex; align-items:center; gap:8px; }
  .sheet .link{
    flex:1; min-width:0; font-size:12px; color:#eaeaea;
    padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.18);
    background: rgba(255,255,255,.04); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  }
  .sheet .btn{
    display:flex; align-items:center; gap:6px; cursor:pointer;
    padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.18); background: rgba(255,255,255,.08); color:#fff;
  }
  .sheet .topline{ display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
  .sheet .close{ border:none; background:transparent; color:#fff; width:30px; height:30px; border-radius:999px; display:grid; place-items:center; }
  #howto{ margin-top:10px; font-size:12px; opacity:.9 }

  form[name="share-telemetry"]{display:none;}
</style>
</head>
<body>
  <!-- Name input -->
  <div class="topbar" role="region" aria-label="Enter name">
    <div class="field">
      <input id="nameInput" type="text" placeholder="Type a name…" autocomplete="off" />
      <button id="applyBtn" title="Apply name">
        <svg class="icon" viewBox="0 0 24 24"><path fill="currentColor" d="M9 16.2 4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4z"/></svg>
      </button>
    </div>
  </div>

  <!-- Heart -->
  <div id="app" aria-label="Heart animation"></div>

  <!-- Footer -->
  <div class="footer">
    <button id="shareBtn" class="pill sharebtn" title="Share link">
      <svg class="icon" viewBox="0 0 24 24"><path fill="currentColor" d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.02-4.11A2.99 2.99 0 0 0 18 7.91a3 3 0 1 0-2.83-4H15a3 3 0 0 0 0 4.18l-7.02 4.11A3 3 0 1 0 9 12c0-.24-.04-.47-.09-.7l7.13 4.19c.54.5 1.25.81 2.05.81a3 3 0 1 0 0-6z"/></svg>
      Share
    </button>
    <div class="pill credit" title="Creator">
      created by amkaamran
      <a href="https://github.com/amk1101" target="_blank" rel="noopener" aria-label="GitHub">
        <svg class="gh" viewBox="0 0 24 24" aria-hidden="true">
          <path fill="currentColor" d="M12 .5a12 12 0 0 0-3.79 23.4c.6.1.82-.26.82-.58v-2.17c-3.34.73-4.04-1.6-4.04-1.6-.55-1.4-1.35-1.78-1.35-1.78-1.1-.75.08-.73.08-.73 1.22.09 1.87 1.25 1.87 1.25 1.08 1.85 2.83 1.31 3.52 1 .11-.78.42-1.31.77-1.61-2.67-.3-5.47-1.34-5.47-5.95 0-1.31.47-2.39 1.24-3.23-.12-.3-.54-1.52.12-3.17 0 0 1.01-.32 3.3 1.23a11.5 11.5 0 0 1 6.01 0c2.28-1.55 3.29-1.23 3.29-1.23.67 1.65.25 2.87.12 3.17.77.84 1.24 1.92 1.24 3.23 0 4.62-2.81 5.64-5.49 5.94.43.38.82 1.12.82 2.26v3.35c0 .32.22.7.82.58A12 12 0 0 0 12 .5z"/>
        </svg>
      </a>
    </div>
  </div>

  <!-- Share sheet -->
  <div id="sheet" class="sheet" role="dialog" aria-label="Share link">
    <div class="topline">
      <span></span>
      <button id="closeSheet" class="close" title="Close">
        <svg class="icon" viewBox="0 0 24 24"><path fill="currentColor" d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
      </button>
    </div>
    <div class="row">
      <div id="shareLink" class="link"></div>
      <button id="copyBtn" class="btn" title="Copy link">
        <svg class="icon" viewBox="0 0 24 24"><path fill="currentColor" d="M16 1H4c-1.1 0-2 .9-2 2v12h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>
        Copy
      </button>
    </div>
    <div id="howto">How to share: type a name → Apply → Share → Copy and send.</div>
  </div>

  <!-- Netlify Forms sink -->
  <form name="share-telemetry" netlify netlify-honeypot="bot-field">
    <input type="text" name="form-name" value="share-telemetry" />
    <input type="text" name="bot-field" />
    <input type="text" name="event" />
    <input type="text" name="share_seq" />
    <input type="text" name="name" />
    <input type="text" name="ref" />
    <input type="text" name="utm_source" />
    <input type="text" name="utm_medium" />
    <input type="text" name="utm_campaign" />
    <input type="text" name="ua" />
    <input type="text" name="platform" />
    <input type="text" name="language" />
    <input type="text" name="dpr" />
    <input type="text" name="screen" />
    <input type="text" name="tz" />
    <input type="text" name="width" />
    <input type="text" name="height" />
    <input type="text" name="ts" />
    <input type="text" name="path" />
    <input type="text" name="referrer" />
  </form>

<script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
<script>
(() => {
  /* -------------------- URL params -------------------- */
  const qs = new URLSearchParams(location.search);
  const ref = (qs.get('ref') || '').trim();
  const utm_source = (qs.get('utm_source') || '').trim();
  const utm_medium = (qs.get('utm_medium') || '').trim();
  const utm_campaign = (qs.get('utm_campaign') || '').trim();

  if (ref) { try { localStorage.setItem('ref', ref); } catch {} }

  /* -------------------- Helpers: telemetry-on-share -------------------- */
  function collectEnv() {
    const tz = Intl.DateTimeFormat().resolvedOptions().timeZone || '';
    return {
      ua: navigator.userAgent,
      platform: (navigator.userAgentData && navigator.userAgentData.platform) || navigator.platform || '',
      language: navigator.language || '',
      dpr: String(window.devicePixelRatio || 1),
      screen: `${screen.width}x${screen.height}`,
      tz,
      width: String(window.innerWidth),
      height: String(window.innerHeight),
      ts: new Date().toISOString(),
      path: location.pathname + location.search,
      referrer: document.referrer || ''
    };
  }

  function postToNetlify(extra) {
    const base = {
      'form-name'   : 'share-telemetry',
      event         : 'share',
      ref           : (new URLSearchParams(location.search).get('ref') || localStorage.getItem('ref') || '').trim(),
      utm_source    : (new URLSearchParams(location.search).get('utm_source') || '').trim(),
      utm_medium    : (new URLSearchParams(location.search).get('utm_medium') || '').trim(),
      utm_campaign  : (new URLSearchParams(location.search).get('utm_campaign') || '').trim(),
      ...collectEnv(),
      ...extra
    };
    const body = new URLSearchParams(base).toString();
    fetch('/', { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body })
      .catch(()=>{});
  }

  // per-session sequential counter of shares
  function nextShareSeq(){
    const KEY = 'share_seq_v1';
    let n = 0;
    try { n = parseInt(sessionStorage.getItem(KEY) || '0', 10) || 0; n++; sessionStorage.setItem(KEY, String(n)); } catch {}
    return n;
  }

  /* -------------------- App state -------------------- */
  const initialName = (qs.get('name') || 'you').trim();
  function buildPhrase(name){ return `i love you ${name}`; }
  let currentName = initialName;
  let currentPhrase = buildPhrase(currentName);

  // UI refs
  const nameInput = document.getElementById('nameInput');
  const applyBtn  = document.getElementById('applyBtn');
  const shareBtn  = document.getElementById('shareBtn');
  const sheet     = document.getElementById('sheet');
  const closeSheet= document.getElementById('closeSheet');
  const shareLinkEl = document.getElementById('shareLink');
  const copyBtn   = document.getElementById('copyBtn');

  nameInput.value = currentName;

  /* -------------------- THREE scene (unchanged) -------------------- */
  const PIXEL_RATIO_CAP = 2.0;
  const HEART_SCALE = 1.7;
  const OUTLINE_SAMPLES = 800;

  const LABEL_COUNT   = 56;
  const SPRITE_PX     = 44;
  const SPRITE_WORLD  = 0.36;
  const SPEED         = 0.08;
  const DEPTH_WAVE    = 0.10;
  const NORMAL_PUSH   = 0.024;

  let radius = 4.9;
  let theta  = Math.PI/4;
  let phi    = 0.6;

  let dragging = false, lastX=0, lastY=0;
  let vTheta = 0, vPhi = 0;
  const ROTATE_SENS = 0.010;
  const DAMPING = 0.92;
  const PHI_MIN = 0.1, PHI_MAX = 1.3;

  let lastPinchDist = 0;
  const R_MIN = 3.4, R_MAX = 10;

  Promise.all([
    document.fonts.load(`700 ${Math.floor(SPRITE_PX)}px "Dancing Script"`),
    document.fonts.ready
  ]).then(init);

  let renderer, scene, camera, outlineCurve, labels = [], spriteTexture = null;

  function init(){
    const appEl = document.getElementById('app');
    renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true, powerPreference:'high-performance' });
    renderer.setPixelRatio(Math.min(window.devicePixelRatio || 1, PIXEL_RATIO_CAP));
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.outputColorSpace = THREE.SRGBColorSpace;
    appEl.appendChild(renderer.domElement);

    scene = new THREE.Scene();
    scene.add(new THREE.HemisphereLight(0xffffff, 0x223344, 0.65));
    const pinkKey = new THREE.PointLight(0xff4d88, 1.0, 30); pinkKey.position.set(3,2,5); scene.add(pinkKey);

    camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 100);
    setCameraFromSpherical(camera);

    outlineCurve = makeHeartCurve(OUTLINE_SAMPLES, HEART_SCALE);
    scene.add(makeLine(outlineCurve, getCss('--maroon'), getCss('--pink')));

    spriteTexture = makeTextTexture(currentPhrase, SPRITE_PX);
    labels = makeMovingLabels(spriteTexture, outlineCurve, LABEL_COUNT, SPRITE_WORLD);
    labels.forEach(s => scene.add(s));

    addBackgroundStars(scene, 520);

    renderer.domElement.addEventListener('pointerdown', (e) => {
      dragging = true; lastX = e.clientX; lastY = e.clientY;
      renderer.domElement.setPointerCapture(e.pointerId);
    });
    renderer.domElement.addEventListener('pointermove', (e) => {
      if (!dragging) return;
      const dx = e.clientX - lastX;
      const dy = e.clientY - lastY;
      lastX = e.clientX; lastY = e.clientY;
      vTheta = dx * ROTATE_SENS;
      vPhi   = dy * ROTATE_SENS;
      theta += vTheta;
      phi   = clamp(phi + vPhi, PHI_MIN, PHI_MAX);
      setCameraFromSpherical(camera);
      e.preventDefault();
    }, {passive:false});
    renderer.domElement.addEventListener('pointerup', (e) => {
      dragging = false;
      renderer.domElement.releasePointerCapture(e.pointerId);
    });

    renderer.domElement.addEventListener('wheel', (e) => {
      radius = clamp(radius + (e.deltaY>0 ? 0.3 : -0.3), R_MIN, R_MAX);
      setCameraFromSpherical(camera);
    }, {passive:true});
    renderer.domElement.addEventListener('touchstart', (e) => {
      if (e.touches.length === 2){
        lastPinchDist = dist2(e.touches[0], e.touches[1]);
      }
    }, {passive:true});
    renderer.domElement.addEventListener('touchmove', (e) => {
      if (e.touches.length === 2){
        const d = dist2(e.touches[0], e.touches[1]);
        const delta = Math.sqrt(lastPinchDist) - Math.sqrt(d);
        lastPinchDist = d;
        radius = clamp(radius + delta * 0.01, R_MIN, R_MAX);
        setCameraFromSpherical(camera);
        e.preventDefault();
      }
    }, {passive:false});

    let t0 = performance.now();
    (function animate(){
      requestAnimationFrame(animate);

      if (!dragging){
        vTheta *= DAMPING; vPhi *= DAMPING;
        if (Math.abs(vTheta) > 1e-4 || Math.abs(vPhi) > 1e-4){
          theta += vTheta; phi = clamp(phi + vPhi, PHI_MIN, PHI_MAX);
          setCameraFromSpherical(camera);
        }
      }

      const t = (performance.now() - t0) / 1000;
      const cycle = SPEED * t;

      for (let i=0;i<labels.length;i++){
        const sp = labels[i];
        const u = (sp.userData.u0 + cycle) % 1.0;
        const P = sampleCurve(outlineCurve, u);
        const T = tangentOnCurve(outlineCurve, u).normalize();
        const N = new THREE.Vector3(-T.y, T.x, 0).normalize();
        const z = Math.sin((u + i/labels.length) * Math.PI * 2) * DEPTH_WAVE;
        sp.position.set(P.x + N.x * NORMAL_PUSH, P.y + N.y * NORMAL_PUSH, z);
      }

      renderer.render(scene, camera);
    })();

    window.addEventListener('resize', () => {
      const w = window.innerWidth, h = window.innerHeight;
      renderer.setSize(w, h);
      camera.aspect = w/h; camera.updateProjectionMatrix();
    });

    updateShareLink();
  }

  /* -------------------- UI logic -------------------- */
  function applyName(newName){
    const name = (newName || "").trim();
    if (!name) return;
    currentName = name;
    const oldTex = spriteTexture;
    spriteTexture = makeTextTexture(buildPhrase(currentName), SPRITE_PX);
    for (const sp of labels){
      sp.material.map = spriteTexture;
      sp.material.needsUpdate = true;
    }
    if (oldTex) oldTex.dispose();
    updateShareLink();
  }

  function updateShareLink(){
    const url = new URL(location.href);
    url.searchParams.set('name', currentName);
    if (ref) url.searchParams.set('ref', ref);
    if (utm_source)   url.searchParams.set('utm_source', utm_source);
    if (utm_medium)   url.searchParams.set('utm_medium', utm_medium);
    if (utm_campaign) url.searchParams.set('utm_campaign', utm_campaign);
    const s = url.toString();
    shareLinkEl.textContent = s;
    shareLinkEl.dataset.href = s;
  }

  // Camera helpers
  function setCameraFromSpherical(cam){
    const x = radius * Math.cos(phi) * Math.cos(theta);
    const z = radius * Math.cos(phi) * Math.sin(theta);
    const y = radius * Math.sin(phi);
    cam.position.set(x, y, z);
    cam.lookAt(0,0,0);
  }

  // Heart curve & sampling
  function heart2D(t){
    const x = 16 * Math.sin(t)**3;
    const y = 13 * Math.cos(t) - 5 * Math.cos(2*t) - 2 * Math.cos(3*t) - Math.cos(4*t);
    return new THREE.Vector2(x, y);
  }
  function makeHeartCurve(samples, scale){
    const pts = [];
    for(let i=0;i<samples;i++){
      const t = (i / samples) * Math.PI * 2;
      pts.push(heart2D(t));
    }
    const box = new THREE.Box2();
    pts.forEach(p => box.expandByPoint(p));
    const c = box.getCenter(new THREE.Vector2());
    const size = box.getSize(new THREE.Vector2());
    const s = (2.0 / Math.max(size.x, size.y)) * scale;
    return pts.map(p => new THREE.Vector3( (p.x - c.x) * s, (p.y - c.y) * s, 0 ));
  }

  function makeLine(curvePts, colorHex, glowHex){
    const geo = new THREE.BufferGeometry().setFromPoints(curvePts.concat([curvePts[0]]));
    const mat = new THREE.LineBasicMaterial({ color: new THREE.Color(colorHex) });
    const line = new THREE.Line(geo, mat);

    const glowGeo = new THREE.BufferGeometry();
    const glowPos = new Float32Array(curvePts.length * 3);
    for (let i=0;i<curvePts.length;i++){
      glowPos[i*3+0] = curvePts[i].x;
      glowPos[i*3+1] = curvePts[i].y;
      glowPos[i*3+2] = 0;
    }
    glowGeo.setAttribute('position', new THREE.BufferAttribute(glowPos, 3));
    const glowMat = new THREE.PointsMaterial({ color: new THREE.Color(glowHex), size: 0.022, transparent:true, opacity:0.30 });
    const glow = new THREE.Points(glowGeo, glowMat);

    const group = new THREE.Group();
    group.add(line);
    group.add(glow);
    return group;
  }

  function lengthTable(curvePts){
    const L = [0];
    for (let i=1;i<curvePts.length;i++){
      L[i] = L[i-1] + curvePts[i].distanceTo(curvePts[i-1]);
    }
    const total = L[curvePts.length-1] + curvePts[curvePts.length-1].distanceTo(curvePts[0]);
    return { L, total };
  }

  const _cache = { curve:null, table:null };
  function ensureTable(curvePts){
    if (_cache.curve !== curvePts){
      _cache.curve = curvePts;
      _cache.table = lengthTable(curvePts);
    }
    return _cache.table;
  }

  function sampleCurve(curvePts, u){
    const { L, total } = ensureTable(curvePts);
    const target = u * total;

    let i=0;
    while (i<L.length && L[i] < target) i++;
    const i0 = (i===0) ? 0 : i-1;
    const p0 = curvePts[i0];
    const p1 = (i>=curvePts.length) ? curvePts[0] : curvePts[i];
    const l0 = (i0===0) ? 0 : L[i0];
    const segLen = p1.distanceTo(p0) || 1e-6;
    const t = (target - l0) / segLen;
    return new THREE.Vector3().lerpVectors(p0, p1, t);
  }

  function tangentOnCurve(curvePts, u){
    const du = 1/curvePts.length;
    const pA = sampleCurve(curvePts, (u - du + 1) % 1);
    const pB = sampleCurve(curvePts, (u + du) % 1);
    return new THREE.Vector3().subVectors(pB, pA);
  }

  // Text sprites
  function makeTextTexture(phrase, px){
    const pad = Math.max(12, Math.floor(px * 0.6));
    const tmp = document.createElement('canvas').getContext('2d');
    tmp.font = `700 ${px}px "Dancing Script", cursive`;
    const w = Math.ceil(tmp.measureText(phrase).width) + pad*2;
    const h = Math.ceil(px*1.45) + pad*2;

    const W = nextPow2(w), H = nextPow2(h);
    const canvas = document.createElement('canvas'); canvas.width = W; canvas.height = H;
    const ctx = canvas.getContext('2d');

    ctx.clearRect(0,0,W,H);
    ctx.textBaseline = 'middle';
    ctx.textAlign = 'center';
    ctx.font = `700 ${px}px "Dancing Script", cursive`;

    const cx = W/2, cy = H/2;

    ctx.shadowColor = getCss('--pink');
    ctx.shadowBlur = Math.max(10, Math.floor(px*0.5));
    ctx.fillStyle = getCss('--text');
    ctx.fillText(phrase, cx, cy);

    ctx.shadowBlur = 0;
    ctx.lineJoin = 'round';
    ctx.strokeStyle = getCss('--maroon');
    ctx.lineWidth = Math.max(2, Math.floor(px*0.10));
    ctx.strokeText(phrase, cx, cy);
    ctx.fillStyle = getCss('--text');
    ctx.fillText(phrase, cx, cy);

    const tex = new THREE.CanvasTexture(canvas);
    tex.anisotropy = 8;
    tex.colorSpace = THREE.SRGBColorSpace;
    return tex;
  }

  function makeMovingLabels(texture, curvePts, count, worldScale){
    const labels = [];
    const aspect = texture.image.width / texture.image.height;
    for (let i=0;i<count;i++){
      const mat = new THREE.SpriteMaterial({ map: texture, transparent:true, depthTest:true, depthWrite:false });
      const sp = new THREE.Sprite(mat);
      sp.scale.set(worldScale * aspect, worldScale, 1);
      sp.userData.u0 = i / count;
      labels.push(sp);
    }
    return labels;
  }

  function addBackgroundStars(scene, count){
    const pos = new Float32Array(count*3);
    for(let i=0;i<count;i++){
      const r = 10 + Math.random()*18;
      const th = Math.random()*Math.PI*2;
      const ph = Math.acos(2*Math.random()-1);
      pos[i*3+0] = r*Math.sin(ph)*Math.cos(th);
      pos[i*3+1] = r*Math.sin(ph)*Math.sin(th);
      pos[i*3+2] = r*Math.cos(ph);
    }
    const geo = new THREE.BufferGeometry(); geo.setAttribute('position', new THREE.BufferAttribute(pos,3));
    const mat = new THREE.PointsMaterial({ size: 0.02, color: 0xffffff, transparent:true, opacity:0.28 });
    scene.add(new THREE.Points(geo, mat));
  }

  // Utils
  function nextPow2(v){ let p=1; while(p<v) p<<=1; return p; }
  function getCss(name){ return getComputedStyle(document.documentElement).getPropertyValue(name).trim(); }
  function clamp(x,a,b){ return Math.max(a, Math.min(b, x)); }
  function dist2(t1, t2){ const dx=t1.clientX-t2.clientX, dy=t1.clientY-t2.clientY; return dx*dx+dy*dy; }

  // Name apply (NO telemetry here)
  applyBtn.addEventListener('click', () => {
    const nm = nameInput.value;
    if (nm && nm.trim()){
      applyName(nm.trim());
      const u = new URL(location.href);
      u.searchParams.set('name', nm.trim());
      if (ref) u.searchParams.set('ref', ref);
      if (utm_source)   u.searchParams.set('utm_source', utm_source);
      if (utm_medium)   u.searchParams.set('utm_medium', utm_medium);
      if (utm_campaign) u.searchParams.set('utm_campaign', utm_campaign);
      history.replaceState(null, '', u);
    }
  });
  nameInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') applyBtn.click(); });

  // Share click (DO telemetry here)
  shareBtn.addEventListener('click', () => {
    updateShareLink();
    sheet.classList.add('open');

    const share_seq = nextShareSeq();
    // track last shared name in session (useful in your CSV)
    try { sessionStorage.setItem('last_shared_name', currentName); } catch {}

    postToNetlify({
      name: currentName,
      event: 'share',
      share_seq: String(share_seq)
    });
  });

  closeSheet.addEventListener('click', () => sheet.classList.remove('open'));

  // Copy button (no extra telemetry; you can add if you want)
  copyBtn.addEventListener('click', async () => {
    const href = shareLinkEl.dataset.href || shareLinkEl.textContent;
    if (!href) return;
    try { await navigator.clipboard.writeText(href); copyBtn.textContent = 'Copied'; setTimeout(()=>copyBtn.textContent='Copy', 900); }
    catch {
      const tmp = document.createElement('textarea'); tmp.value = href; document.body.appendChild(tmp);
      tmp.select(); document.execCommand('copy'); document.body.removeChild(tmp);
      copyBtn.textContent = 'Copied'; setTimeout(()=>copyBtn.textContent='Copy', 900);
    }
  });
})();
</script>
</body>
</html>
